@using SherpaFrontEnd.Model
@using SherpaFrontEnd.Services
@using SherpaFrontEnd.Shared.Modals
@using SherpaFrontEnd.Shared.Tabs
@using System.Net
@inject NavigationManager Nav
@inject ITeamDataService TeamDataService
@inject IAssessmentsDataService AssessmentsDataService

@page "/team-content/{TeamId:guid?}"

<h3>
    @Team?.Name
    <button class="btn btn-remove" title="Delete team" @onclick="DeleteTeam">
        <span class="oi oi-trash"></span>
    </button>
</h3>


<TabControl>
    <TabPage Text="Analysis">
        <button>Send a new survey</button>
    </TabPage>
    <TabPage Text="Surveys">
        <div class="py-5 flex justify-center items-center flex-col bg-indigo-50 rounded-3xl gap-2.5">
            <h3 class="mb-4 text-4xl font-extrabold leading-none tracking-tight text-black md:text-5xl lg:text-6xl">All Surveys</h3>
            <p>You don't have any surveys yet</p>
            <button type="button" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Send a new survey</button>
        </div>
        <Members
            Team="@Team"
            OnUpdateTeam="@OnUpdateTeam">
        </Members>
    </TabPage>
    <TabPage Text="Assessments">
        <Assessments
            SurveyTemplates="@SurveyTemplates"
            SelectedTeamAssessments="@Assessments"
            SelectedTeamId="@Team?.Id"
            Emails="@Emails"
            OnAddSurvey="@OnAddSurvey"
            OnCreateEvaluation="@OnUpdateAssessment"
            OnDeleteEvaluation="@OnUpdateAssessment">
        </Assessments>
    </TabPage>
</TabControl>

@code {

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    [Parameter]
    public Guid TeamId { get; set; } = Guid.Empty;

    public Team? Team { get; set; }

    private List<string?> Emails { get; set; } = new();

    private List<SurveyTemplate>? SurveyTemplates { get; set; }

    private List<Assessment>? Assessments { get; set; }

    [CascadingParameter]
    public IModalService Modal { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Team = await TeamDataService.GetTeamById(TeamId);
        Emails = Team!.Members.Select(m => m.Email).ToList();
        SurveyTemplates = await AssessmentsDataService.GetTemplates();
        Assessments = await AssessmentsDataService.GetAssessments(TeamId);
    }

    private async Task OnUpdateTeam(Team team)
    {
        await TeamDataService.PutTeam(team);
    }

    private async Task OnUpdateAssessment(Assessment assessment)
    {
        await AssessmentsDataService.PutAssessment(assessment);
    }

    private async Task OnAddSurvey(SurveyTemplate template)
    {
        var assessmentName = $"{template.Name} {DateTime.Now}";
        var assessment = await AssessmentsDataService.AddAssessment(TeamId, template.Id, assessmentName);

        if (assessment is not null)
        {
            Assessments!.Add(assessment);
        }
    }

    private async void DeleteTeam()
    {
        var modal = Modal.Show<ConfirmationModal>($"Delete {Team!.Name}?");
        var modalResult = await modal.Result;

        if (!modalResult.Cancelled)
        {
            var deleteStatus = await TeamDataService.DeleteTeam(TeamId);
            if (deleteStatus == HttpStatusCode.OK)
            {
                Nav.NavigateTo("/teams-list-page");
    //TODO alert (on teams page) successfully deleted
            }
    //TODO alert (on this page) team wasn't deleted
        }
    }

}